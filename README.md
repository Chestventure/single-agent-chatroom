# 15ì¼ ë°˜ì¥ Â· Night Time ì±„íŒ… ì›¹ ë°ëª¨

ë©€í‹° ì—ì´ì „íŠ¸(4ëª… NPC)ê°€ **1~3ì´ˆ ëœë¤ ì§€ì—°**ìœ¼ë¡œ ë²ˆê°ˆì•„ê°€ë©° ì±„íŒ…ì„ ìƒì„±í•˜ê³ ,
í”Œë ˆì´ì–´ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì°¸ì—¬í•  ìˆ˜ ìˆëŠ” **3ë¶„ íƒ€ì„ì–´íƒ** ì±„íŒ…ë°© ë°ëª¨ì…ë‹ˆë‹¤.

> ì´ ë°ëª¨ëŠ” ë¡œì»¬ ê·œì¹™ ê¸°ë°˜ "LLM ìŠ¤í…"ìœ¼ë¡œ NPC ëŒ€ì‚¬ë¥¼ ë§Œë“­ë‹ˆë‹¤. ì‹¤ì œ LLM APIë¡œ ë°”ê¾¸ë„ë¡ ì„¤ê³„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

## ë¯¸ë¦¬ë³´ê¸°
- ì¢Œì¸¡: ì¸ë¬¼ ì†Œê°œ, ë‚®(Context) ì…ë ¥, ì‹œì‘/ì¤‘ì§€/ì´ˆê¸°í™”
- ìš°ì¸¡: ì‹¤ì‹œê°„ ì±„íŒ…, í”Œë ˆì´ì–´ ì…ë ¥ì°½
- ìƒë‹¨ ë°”: 3ë¶„ íƒ€ì´ë¨¸ + ì§„í–‰ ë°”

## ì‹¤í–‰ ë°©ë²•

### 1) ìš”êµ¬ ì‚¬í•­
- Python 3.10+
- ê°€ìƒí™˜ê²½ ê¶Œì¥

### 2) ì„¤ì¹˜ & ì‹¤í–‰
```bash
pip install -r requirements.txt
uvicorn server:app --reload --port 8000
```
ë¸Œë¼ìš°ì €ì—ì„œ `http://127.0.0.1:8000` ì ‘ì†

## ì‚¬ìš©ë²•
1. ì¢Œì¸¡ íŒ¨ë„ì˜ **ë‚®ì— ìˆì—ˆë˜ ì¼(Context)** í…ìŠ¤íŠ¸ ì˜ì—­ì— ì˜¤ëŠ˜ ë‚®ì˜ ì‚¬ê±´ì„ ì ìŠµë‹ˆë‹¤.
2. **ì‹œì‘(3ë¶„)** ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ 1~3ì´ˆ ê°„ê²©ìœ¼ë¡œ NPCê°€ ë§í•˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤.
3. í”Œë ˆì´ì–´ë„ í•˜ë‹¨ ì…ë ¥ì°½ìœ¼ë¡œ ììœ ë¡­ê²Œ ëŒ€í™”ì— ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
4. 3ë¶„ì´ ì§€ë‚˜ë©´ íƒ€ì´ë¨¸ê°€ ì¢…ë£Œë˜ê³  ì˜¤ëŠ˜ì˜ Night Timeì´ ëë‚©ë‹ˆë‹¤.

## ì„¤ê³„ ê°œìš”

### êµ¬ì¡°
```
server.py         # FastAPI + WebSocket ì„œë²„
static/index.html # UI
static/styles.css # UI ìŠ¤íƒ€ì¼
static/app.js     # í´ë¼ì´ì–¸íŠ¸ ë¡œì§ (WebSocket, UI ë Œë”)
```

### WebSocket í”„ë¡œí† ì½œ
- í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„
  - `{"type":"chat","speaker":"ë‚˜","text":"ë©”ì‹œì§€ ë‚´ìš©"}`
  - `{"type":"control","payload":{"action":"start","duration":180,"day_context":"â€¦"}}`
  - `{"type":"control","payload":{"action":"stop"}}`
  - `{"type":"clear"}`

- ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸
  - `{"type":"init","personas":[â€¦],"history":[â€¦],"running":true,"time_left":172}`
  - `{"type":"chat","message":{role,speaker,text,ts}}`
  - `{"type":"timer","time_left":169}`
  - `{"type":"state","running":true|false}`
  - `{"type":"phase_end","reason":"timer_end"}`
  - `{"type":"context","day_context":"â€¦"}`
  - `{"type":"cleared"}` / `{"type":"error","message":"â€¦"}`

### LLM ìŠ¤í… êµì²´í•˜ê¸°
`server.py`ì˜ `generate_npc_message(...)` í•¨ìˆ˜ë¥¼ ì‹¤ì œ LLMìœ¼ë¡œ êµì²´í•˜ë©´ ë©ë‹ˆë‹¤.
ì˜ˆì‹œ(ì˜ì‚¬ ì½”ë“œ):
```python
def generate_npc_message(p, history, day_context, room_label):
    prompt = make_prompt(persona=p, history=history, context=day_context, room=room_label)
    # ex) OpenAI, Upstage ë“± ì›í•˜ëŠ” API í˜¸ì¶œ
    return call_llm(prompt)
```
- **ë°œí™”ì ì„ íƒ ë¡œì§**: `choose_speaker`ì—ì„œ ìµœê·¼ ì–¸ê¸‰ëœ ì¸ë¬¼ì„ ì•½í•˜ê²Œ ê°€ì¤‘ì¹˜ë¡œ ì˜¬ë¦½ë‹ˆë‹¤.
- **1~3ì´ˆ ëœë¤ ì§€ì—°**: `_chat_loop()`ì—ì„œ `await asyncio.sleep(random.uniform(1.0, 3.0))`

### ë©€í‹°ë£¸/ë©€í‹°ì„¸ì…˜ í™•ì¥
- `RoomState`ë¥¼ ì—¬ëŸ¬ ê°œ ê´€ë¦¬í•˜ë„ë¡ ë°”ê¾¸ë©´ ë‹¤ì–‘í•œ ë°˜/ì±„íŒ…ë°©ì„ ë™ì‹œì— ëŒë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- í˜„ì¬ ë°ëª¨ëŠ” ë‹¨ì¼ ë£¸(â€œNight Timeâ€)ë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.

## ë¼ì´ì„ ìŠ¤
MIT


## ğŸ”Œ ì‹¤ì œ LLM ì‚¬ìš© ì„¤ì •


1) `.env.example`ë¥¼ ë³µì‚¬í•´ `.env` ìƒì„± í›„ **OPENAI_API_KEY** ì±„ì›Œë„£ê¸°
```bash
cp .env.example .env
# í¸ì§‘ê¸°ë¡œ OPENAI_API_KEY ì…ë ¥
```
2) (ì„ íƒ) `OPENAI_MODEL` ë³€ê²½ ê°€ëŠ¥: `gpt-4o-mini`(ê¸°ë³¸), `gpt-4o`, `o4-mini` ë“±
3) ì„œë²„ ì‹¤í–‰
```bash
pip install -r requirements.txt
uvicorn server:app --reload --port 8000
```
4) ë¸Œë¼ìš°ì € ì ‘ì†: `http://127.0.0.1:8000`

### í”„ë¡¬í”„íŠ¸/ì²´ì¸ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ
- `server.py`ì˜ `generate_npc_message_llm(...)`ì—ì„œ í”„ë¡¬í”„íŠ¸/ì˜¨ë„/í† í° ì œí•œ ë“±ì„ ì¡°ì •í•˜ì„¸ìš”.
- ì‘ë‹µì€ **í•œ ì¤„**, **ìµœëŒ€ 90ì**, **ìì—°ìŠ¤ëŸ¬ìš´ ì¹´í†¡ì²´**ë¥¼ ê°•ì œí•©ë‹ˆë‹¤.
- API ì˜¤ë¥˜Â·í‚¤ ëˆ„ë½ ì‹œ ìë™ìœ¼ë¡œ **ìŠ¤í…**ìœ¼ë¡œ í´ë°±í•©ë‹ˆë‹¤.


## ğŸ¤– ë‹¤ìŒ ë°œí™”ìê¹Œì§€ LLMì´ ê²°ì •

- ë” ì´ìƒ ì„œë²„ê°€ ëœë¤/ê·œì¹™ìœ¼ë¡œ ë°œí™”ìë¥¼ ê³ ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.
- LLMì´ ìµœê·¼ ëŒ€í™”/ë‚® ì»¨í…ìŠ¤íŠ¸/í˜ë¥´ì†Œë‚˜ë¥¼ ë³´ê³  **ë‹¤ìŒìœ¼ë¡œ ë§í•  ì¸ë¬¼(speaker_key)** ê³¼ **ê·¸ ëŒ€ì‚¬(text)** ë¥¼ **JSON**ìœ¼ë¡œ í•œ ë²ˆì— ë°˜í™˜í•©ë‹ˆë‹¤.
- ì‹¤íŒ¨ ì‹œì—ë„ ëœë¤ì´ ì•„ë‹ˆë¼ **ë¼ìš´ë“œë¡œë¹ˆ(ê²°ì •ì  ìˆœì„œ)** ìœ¼ë¡œ í´ë°±í•©ë‹ˆë‹¤.
- êµ¬í˜„: `server.py`ì˜ `generate_next_turn_llm(...)` + `NextTurn` ìŠ¤í‚¤ë§ˆ(Pydantic). `with_structured_output` ì‚¬ìš©.
